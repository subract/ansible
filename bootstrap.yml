---

- hosts: all 
  become: true
  vars_prompt:
  - name: password
    prompt: "desired sudo password"
    unsafe: yes # allows special characters
    private: yes
    encrypt: sha512_crypt
    confirm: yes

  tasks:
  - name: Create user
    user:
      name: "{{ user }}"
      groups: sudo
    register: new_user
  - name: Set ssh key for user
    authorized_key:
      user: "{{ user }}"
      key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOcIlNwYsyjIhu6Pg/+67BpORsW8RdnJnvs12XvWSV8g Homelab aven"
      exclusive: yes
    when: new_user.changed
  - name: Set user password
    user:
      name: "{{ user }}"
      password: "{{ password }}"
    when: new_user.changed
